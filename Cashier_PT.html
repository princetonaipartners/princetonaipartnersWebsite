<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hamilton Deli & Grill — Concierge</title>
<style>
  :root{
    --bg:#0b1020; --card:#101629; --ink:#e8ecff; --muted:#9aa3b2;
    --brand:#5fe1a5; --brand2:#55c9ff; --accent:#ffd166;
    --ring:#2a375a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
  }
  html,body{margin:0;height:100%;background:
    radial-gradient(80% 140% at 10% -10%, rgba(85,201,255,.18), transparent 55%),
    radial-gradient(60% 120% at 110% -10%, rgba(95,225,165,.15), transparent 45%),
    var(--bg);
    color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  }
  .wrap{max-width:940px;margin:28px auto;padding:0 18px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;position:relative;}
  h1{margin:0 0 8px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);margin-bottom:12px}
  .grid{display:grid;gap:14px}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:1fr 1fr 1fr}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-weight:700}
  input[type="tel"],input[type="number"],input[type="text"]{
    background:#0e1425;color:#fff;border:1px solid #243055;border-radius:12px;
    padding:14px;font-size:18px;outline:none;
  }
  input:focus{box-shadow:0 0 0 3px var(--ring);border-color:#37508f}
  .hint{color:var(--muted);font-size:14px}
  .tiles{display:flex;flex-wrap:wrap;gap:10px}
  .tile{padding:10px 12px;border:1px solid #2b355a;border-radius:12px;cursor:pointer;user-select:none;
        background:#0f162a;color:#dbe1ff;font-weight:700}
  .tile.sel{border-color:#59d09f;background:rgba(89,208,159,.12)}
  .row{display:flex;align-items:center;gap:10px}
  .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
  button{padding:14px 18px;border:none;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer}
  .primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#08111f}
  .ghost{background:#0e1425;color:#c7d2fe;border:1px solid #2b355a}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .banner{display:none;margin-bottom:12px;padding:12px 14px;border-radius:12px;font-weight:700}
  .ok{background:#123724;color:#9ff3c9;border:1px solid #1f6b49}
  .warn{background:#3a2a07;color:#ffe2a6;border:1px solid #8d6b19}
  .err{background:#3d0f17;color:#ffd0d8;border:1px solid #8f2236}
  .kpi{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 2px}
  .chip{padding:8px 10px;border-radius:10px;background:#0d233a;border:1px solid #233a57;color:#cfe6ff;font-weight:700}
  .chip.badge{background:#2a1f00;border-color:#5a4706;color:#ffd978}
  .summary{background:#0e1425;border:1px solid #2b355a;border-radius:12px;padding:14px}
  .muted{color:#9aa3b2}
  .big{font-size:22px;font-weight:800}
  .right{margin-left:auto}
  .loading[hidden]{display:none !important;}
  .loading{position:absolute;inset:0;background:rgba(10,14,25,.55);backdrop-filter:blur(1px);
           border-radius:var(--radius);display:flex;align-items:center;justify-content:center;gap:10px;z-index:5;}
  .spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(85,201,255,.25);border-top-color:#55c9ff;animation:spin .9s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media (max-width:800px){.two,.three{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <!-- LOOKUP CARD -->
  <div class="card" id="lookupCard" aria-live="polite">
    <div class="loading" id="loadingA" hidden>
      <div class="spinner" aria-hidden="true"></div><div>Working…</div>
    </div>
    <h1>Hamilton Deli & Grill — Cashier</h1>
    <div class="sub">Lookup customer, log purchase, apply rewards.</div>

    <div id="bannerA" class="banner"></div>

    <div class="grid two">
      <div class="field">
        <label for="phone">Customer phone *</label>
        <input id="phone" type="tel" inputmode="tel" placeholder="(555) 123-4567" autocomplete="tel" />
        <div class="hint">Digits only; last 10 are used.</div>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="primary" id="btnLookup">Lookup / Start Visit</button>
      </div>
    </div>

    <div id="enrollBox" style="display:none;margin-top:10px">
      <div class="banner warn" style="display:block">Customer not enrolled.</div>
      <div class="grid two">
        <div>
          <div class="hint">Ask customer to scan to enroll once.</div>
          <div class="tiles" style="margin-top:8px">
            <a class="tile" id="signupLink" target="_blank" rel="noopener">Open Sign-up</a>
            <button class="tile" id="btnShowQR" type="button">Show QR</button>
          </div>
        </div>
        <div id="qrBox" style="display:none">
          <img id="qrImg" alt="Sign-up QR" style="max-width:180px;border-radius:12px;border:1px solid #2b355a"/>
        </div>
      </div>
    </div>
  </div>

  <!-- LOG CARD -->
  <div class="card" id="logCard" style="display:none" aria-live="polite">
    <div class="loading" id="loadingB" hidden><div class="spinner"></div><div>Finalizing…</div></div>
    <div id="bannerB" class="banner"></div>

    <div class="grid two">
      <div>
        <h2 id="custName" style="margin:0 0 6px">Customer</h2>
        <div class="kpi">
          <span class="chip" id="chipPhone">Phone</span>
          <span class="chip" id="chipPoints">Points: 0</span>
          <span class="chip" id="chipVisits">Visits: 0</span>
          <span class="chip" id="chipNext">Next reward in —</span>
          <span class="chip badge" id="chipEligible" style="display:none">Eligible: Free drink</span>
        </div>
      </div>
      <div class="summary">
        <div class="row"><div>Subtotal</div><div class="right big" id="sumSubtotal">$0.00</div></div>
        <div class="row"><div class="muted">Reward</div><div class="right" id="sumReward">—</div></div>
        <div class="row"><div class="muted">Review bonus</div><div class="right" id="sumReview">—</div></div>
        <div class="row"><div class="muted">Points discount</div><div class="right" id="sumPts">$0.00</div></div>
        <hr style="border:none;border-top:1px solid #2b355a;margin:10px 0">
        <div class="row"><div class="big">Net to charge</div><div class="right big" id="sumNet">$0.00</div></div>
      </div>
    </div>

    <div class="grid two" style="margin-top:10px">
      <div class="field">
        <label for="orderTotal">Order total ($) *</label>
        <input id="orderTotal" type="number" min="0" step="0.01" placeholder="0.00" />
        <div class="hint" id="pointsHint">Points this visit: 0</div>
      </div>
      <div class="field">
        <label class="row" style="margin-top:6px">
          <input type="checkbox" id="reviewVerified">
          <span>Review verified in-store (-$5 bonus)</span>
        </label>
        <label class="row" id="applyWrap">
          <input type="checkbox" id="applyReward" disabled>
          <span>Apply free Coffee/20oz drink now</span>
        </label>
      </div>
    </div>

    <div class="grid two">
      <div class="field">
        <label for="redeemPts">Redeem points</label>
        <input id="redeemPts" type="number" min="0" step="1" placeholder="0" />
        <div class="hint" id="redeemHint">Available: 0 · $0.00 value (100 pts = $5)</div>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="ghost" id="btnMaxRedeem" type="button">Redeem Max</button>
      </div>
    </div>

    <div class="field" style="margin-top:6px">
      <label>Categories in this order</label>
      <div class="tiles" id="catTiles"></div>
      <div class="hint">Tap all that apply.</div>
    </div>

    <div class="actions">
      <button class="primary" id="btnFinalize">Finalize visit</button>
      <button class="ghost" id="btnBack">Start next customer</button>
    </div>
  </div>

  <!-- CONFIRM CARD -->
  <div class="card" id="doneCard" style="display:none" aria-live="polite">
    <div class="banner ok" style="display:block" id="doneMsg">Visit logged.</div>
    <div class="summary">
      <div class="row"><div>Subtotal</div><div class="right" id="doneSubtotal">$0.00</div></div>
      <div class="row"><div>Reward</div><div class="right" id="doneReward">—</div></div>
      <div class="row"><div>Review bonus</div><div class="right" id="doneReview">—</div></div>
      <div class="row"><div>Points discount</div><div class="right" id="donePts">$0.00</div></div>
      <hr style="border:none;border-top:1px solid #2b355a;margin:10px 0">
      <div class="row"><div class="big">Net</div><div class="right big" id="doneNet">$0.00</div></div>
    </div>
    <div class="actions"><button class="primary" id="btnReset">Start next customer</button></div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const WEBHOOK_LOOKUP  = 'https://princetonai.app.n8n.cloud/webhook/cashier/lookup';
const WEBHOOK_FINALIZE= 'https://princetonai.app.n8n.cloud/webhook/cashier/finalize';

const STORE_ID   = 'hamilton-main';   // optional, sent to n8n
const CASHIER_ID = 'register-1';      // optional, sent to n8n

const SIGNUP_URL = 'https://princetonaipartners.github.io/concierge/signup/';
/* ================================================== */

const CATEGORIES = ['Grocery','Convenience','Coffee','Deli/food','Krispy Chicken','Other'];
const REWARD_CYCLE = 5;
const DOLLARS_PER_POINT = 0.05; // 100 points = $5

const $ = q => document.querySelector(q);
const money = v => (Number.isFinite(+v) ? (+v).toLocaleString(undefined,{style:'currency',currency:'USD'}) : '$0.00');
const clamp  = (v,min,max)=> Math.min(max, Math.max(min, v));
const clamp0 = v => Math.max(0, v||0);
const digits10 = v => {
  const d = String(v||'').replace(/\D/g,'');
  return d.length >= 10 ? d.slice(-10) : null;
};

let state = {
  visitId: null,
  phone10: null,
  customer: null,     // from lookup
  eligibleNow: false, // apply free drink now (disabled for lookup flow)
  alreadyToday: false,
  smsOptin: false,
  points: 0,          // current balance
  reviewEligible: false, // can use $5 review bonus
  redeemPts: 0,
};

function setBanner(elId, kind, text){
  const el = $(elId);
  el.className = `banner ${kind}`;
  el.textContent = text;
  el.style.display = text ? 'block' : 'none';
}
function setLoading(id, on){ $(id).hidden = !on; }

function buildTiles(){
  const box = $('#catTiles'); box.innerHTML = '';
  CATEGORIES.forEach(name=>{
    const div = document.createElement('div');
    div.className = 'tile'; div.textContent = name;
    div.addEventListener('click', ()=>{ div.classList.toggle('sel'); recompute(); });
    box.appendChild(div);
  });
}
function selectedCats(){
  return [...document.querySelectorAll('#catTiles .tile.sel')].map(el=>el.textContent);
}

function maxRedeemPtsGivenSubtotal(subtotal, reviewUsed){
  // Don’t let discounts push net below 0
  const maxDollarsFromPts = clamp0(subtotal - (reviewUsed ? 5 : 0));
  return Math.floor(maxDollarsFromPts / DOLLARS_PER_POINT);
}

function recompute(){
  const subtotal = Number($('#orderTotal').value || 0);
  const reviewUsed = $('#reviewVerified').checked ? 5 : 0;

  // Cap redeem points by available, by subtotal, and by input
  const maxPtsBySubtotal = maxRedeemPtsGivenSubtotal(subtotal, !!reviewUsed);
  const desiredPts = Number($('#redeemPts').value || 0);
  const cap = Math.min(state.points, maxPtsBySubtotal);
  state.redeemPts = clamp(desiredPts, 0, cap);
  if (desiredPts !== state.redeemPts) $('#redeemPts').value = state.redeemPts;

  const ptsDollars = state.redeemPts * DOLLARS_PER_POINT;

  const apply = $('#applyReward').checked && state.eligibleNow ? 'FREE Coffee or 20 oz Drink' : '';
  const rewardDiscount = 0; // free drink rung as $0
  const net = clamp0(subtotal - reviewUsed - rewardDiscount - ptsDollars);

  $('#pointsHint').textContent = `Points this visit: ${Math.max(0, Math.floor(subtotal))}`;
  $('#sumSubtotal').textContent = money(subtotal);
  $('#sumReward').textContent   = apply || '—';
  $('#sumReview').textContent   = reviewUsed ? ('-$'+reviewUsed.toFixed(2)) : '—';
  $('#sumPts').textContent      = ptsDollars ? ('-'+money(ptsDollars)) : '$0.00';
  $('#sumNet').textContent      = money(net);

  // Update hint for redeem input
  const remaining = state.points - state.redeemPts;
  $('#redeemHint').textContent = `Available: ${state.points} · Using ${state.redeemPts} (left ${remaining}) · ${money(state.redeemPts*DOLLARS_PER_POINT)} value (100 pts = $5)`;
}

function resetAll(){
  state = { visitId:null, phone10:null, customer:null, eligibleNow:false, alreadyToday:false, smsOptin:false, points:0, reviewEligible:false, redeemPts:0 };

  $('#phone').value='';
  setBanner('#bannerA','',''); setBanner('#bannerB','','');
  $('#enrollBox').style.display='none'; $('#qrBox').style.display='none';

  $('#orderTotal').value='';
  $('#reviewVerified').checked=false;
  $('#applyReward').checked=false;
  $('#applyReward').disabled=true;
  $('#redeemPts').value='0';

  [...document.querySelectorAll('#catTiles .tile')].forEach(el=>el.classList.remove('sel'));

  $('#lookupCard').style.display='block';
  $('#logCard').style.display='none';
  $('#doneCard').style.display='none';
  recompute();
}
resetAll();
buildTiles();

/* ---------- Lookup ---------- */
$('#btnLookup').addEventListener('click', async ()=>{
  setBanner('#bannerA','','');
  const phone10 = digits10($('#phone').value);
  if (!phone10){ setBanner('#bannerA','warn','Enter a valid phone number.'); return; }

  setLoading('#loadingA', true);
  try{
    const r = await fetch(WEBHOOK_LOOKUP + `?t=${Date.now()}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone: phone10, storeId: STORE_ID, cashierId: CASHIER_ID })
    });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const res = await r.json();

    if (!res.hasAccount){
      $('#enrollBox').style.display='block';
      $('#signupLink').href = SIGNUP_URL;
      $('#qrImg').src = `https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl=${encodeURIComponent(SIGNUP_URL)}`;
      setBanner('#bannerA','warn', res.message || 'Not enrolled. Ask customer to sign up once.');
      return;
    }

    // Snapshot state
    state.phone10      = phone10;
    state.customer     = res;
    state.alreadyToday = !!res.alreadyToday;
    state.smsOptin     = !!res.smsOptin;
    state.points       = Number(res.points ?? 0);
    // ******** FIX: honor API field reviewBonusAvailable ********
    state.reviewEligible = !!res.reviewBonusAvailable;
    state.redeemPts    = 0;

    // Eligibility to apply free drink now is off; reward unlock hint only
    const willUnlockOnFinalize = !!res.willUnlockOnFinalize;
    state.eligibleNow = false;
    $('#applyReward').checked = false;
    $('#applyReward').disabled = true;

    // Fill UI
    const name = res.customerName || 'Customer';
    $('#custName').textContent = name;
    $('#chipPhone').textContent = `(${phone10.slice(0,3)}) ${phone10.slice(3,6)}-${phone10.slice(6)}`;
    $('#chipPoints').textContent = `Points: ${state.points}`;
    $('#chipVisits').textContent = `Visits: ${Number(res.totalVisits ?? 0)}`;
    const vtn = res.visitsToNextReward;
    $('#chipNext').textContent = Number.isFinite(vtn) ? `Next reward in ${vtn} visit(s)` : 'Next reward —';

    const badge = $('#chipEligible');
    if (willUnlockOnFinalize) {
      badge.style.display = 'inline-block';
      badge.textContent = 'Unlocks on finalize';
    } else {
      badge.style.display = 'none';
      badge.textContent = 'Eligible: Free drink';
    }

    // Review bonus eligibility + banner behavior
    $('#reviewVerified').disabled = !state.reviewEligible;
    $('#reviewVerified').checked  = false;
    if (!state.alreadyToday) {
      if (!state.reviewEligible) {
        setBanner('#bannerB','warn','Review bonus already used on this account.');
      } else {
        setBanner('#bannerB','ok', `Welcome back${name ? ', ' + name : ''}!`);
      }
    }

    // Redeem input
    $('#redeemPts').value = '0';
    $('#redeemHint').textContent = `Available: ${state.points} · $${(state.points*DOLLARS_PER_POINT).toFixed(2)} total value (100 pts = $5)`;

    // Finalize availability
    $('#btnFinalize').disabled = !!state.alreadyToday;
    if (state.alreadyToday){
      setBanner('#bannerB','warn','Already checked in today — finalize disabled.');
    }

    // Show log screen
    $('#enrollBox').style.display='none';
    $('#lookupCard').style.display='none';
    $('#logCard').style.display='block';
    $('#orderTotal').focus();
    recompute();
  }catch(e){
    console.error(e);
    setBanner('#bannerA','err','Lookup failed. Check network.');
  }finally{
    setLoading('#loadingA', false);
  }
});

$('#btnShowQR').addEventListener('click', ()=>{
  $('#qrBox').style.display = $('#qrBox').style.display==='none' ? 'block' : 'none';
});

/* ---------- Live recompute on changes ---------- */
$('#orderTotal').addEventListener('input', recompute);
$('#reviewVerified').addEventListener('change', recompute);
$('#applyReward').addEventListener('change', recompute);
$('#redeemPts').addEventListener('input', recompute);
$('#btnMaxRedeem').addEventListener('click', ()=>{
  const subtotal = Number($('#orderTotal').value || 0);
  const maxBySubtotal = maxRedeemPtsGivenSubtotal(subtotal, $('#reviewVerified').checked);
  const cap = Math.min(state.points, maxBySubtotal);
  $('#redeemPts').value = String(cap);
  recompute();
});

/* ---------- Finalize ---------- */
$('#btnFinalize').addEventListener('click', async ()=>{
  const phone10 = state.phone10;
  const subtotal = Number($('#orderTotal').value || 0);
  if (!phone10){ setBanner('#bannerB','warn','Missing phone.'); return; }
  if (!(subtotal >= 0)){ setBanner('#bannerB','warn','Enter a valid order total.'); return; }
  if (state.alreadyToday){ setBanner('#bannerB','warn','Already checked in today.'); return; }

  // visitId for idempotency
  state.visitId = `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;

  const categories = selectedCats();
  const apply = $('#applyReward').checked && state.eligibleNow;
  const payload = {
    visitId: state.visitId,
    phone: phone10,
    orderTotal: subtotal,
    categories,
    reviewVerified: !!$('#reviewVerified').checked,
    redeemPoints: Number(state.redeemPts || 0),
    applyRewards: apply ? ['FIFTH_VISIT_FREE_DRINK'] : [],
    storeId: STORE_ID,
    cashierId: CASHIER_ID,
  };

  setLoading('#loadingB', true);
  try{
    const r = await fetch(WEBHOOK_FINALIZE, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const res = await r.json();

    // Expected: { success, netCharge, orderTotal, rewardLabel, reviewBonus, pointsRedeemed, pointsEarned, newPoints, message }
    const usedPtsDollars = (res.pointsRedeemed ?? state.redeemPts) * DOLLARS_PER_POINT;

    $('#doneSubtotal').textContent = money(res.orderTotal ?? subtotal);
    $('#doneReward').textContent   = res.rewardLabel || (apply ? 'FREE Coffee or 20 oz Drink' : '—');
    $('#doneReview').textContent   = (res.reviewBonus ? '-$'+Number(res.reviewBonus).toFixed(2) : '—');
    $('#donePts').textContent      = usedPtsDollars ? ('-'+money(usedPtsDollars)) : '$0.00';
    $('#doneNet').textContent      = money(res.netCharge ?? Math.max(0, subtotal - (res.reviewBonus||0) - usedPtsDollars));

    $('#doneMsg').textContent = res.message || 'Visit logged. SMS will be sent if opted-in.';
    $('#logCard').style.display='none';
    $('#doneCard').style.display='block';
  }catch(e){
    console.error(e);
    setBanner('#bannerB','err','Finalize failed. Please retry.');
  }finally{
    setLoading('#loadingB', false);
  }
});

/* ---------- Back / Reset ---------- */
$('#btnBack').addEventListener('click', resetAll);
$('#btnReset').addEventListener('click', resetAll);
</script>
</body>
</html>